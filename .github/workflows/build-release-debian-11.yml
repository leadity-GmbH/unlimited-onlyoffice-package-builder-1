name: release-onlyoffice

on:
  push:
    tags:
      - builds-debian-11/*

env:
  DEBIAN_PACKAGE_SUFFIX: -leadity
  TAG_SUFFIX: -leadity
  DISTRO_FULLNAME: Debian 11
  DISTRO_TAG_PREFIX: debian-11

jobs:
  onlyoffice-release:
    strategy:
      matrix:
        TARGET_DISTRO: [ "debian-11" ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Free Space - Cleanup
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$ANDROID_SDK_ROOT"
          sudo rm -rf /usr/local/lib/android
          sudo docker system prune -af
          df -h
      
      - name: Check out the repo
        uses: actions/checkout@v4
      
      - name: Split branch name
        id: split-tag
        run: echo "version=${GITHUB_REF_NAME##*/}" >> $GITHUB_OUTPUT
      
      - name: Get Product version
        id: get-product-version
        run: echo "product-version=${VERSION%.*}" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.split-tag.outputs.version }}
      
      - name: Get Build number
        id: get-build-number
        run: echo "build-number=${VERSION##$PRODUCT_VERSION.}" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.split-tag.outputs.version }}
          PRODUCT_VERSION: ${{ steps.get-product-version.outputs.product-version }}
      
      - name: Patch builder to use custom build_tools
        run: |
          # Create a patch to modify the builder script
          cat > use-custom-build-tools.patch << 'EOF'
          --- onlyoffice-package-builder.sh.orig
          +++ onlyoffice-package-builder.sh
          @@ -54,7 +54,7 @@
           fi
           
           if [ ! -d "${BASE_DIR}/build_tools" ]; then
          -    git clone --depth 1 https://github.com/btactic-oo/build_tools.git
          +    git clone --branch v9.1.0.173-leadity-working --depth 1 https://github.com/leadity-GmbH/build_tools.git
           fi
           
           # Build DocumentServer
          EOF
          
          # Apply the patch
          patch -p0 < use-custom-build-tools.patch || true
          
          # Also modify any other build_tools references
          sed -i 's|btactic-oo/build_tools|leadity-GmbH/build_tools|g' onlyoffice-package-builder.sh
          
          # Show the changes
          grep -n "build_tools" onlyoffice-package-builder.sh
      
      - name: Docker build binaries
        run: |
          sudo ./onlyoffice-package-builder.sh \
            --product-version=${{ steps.get-product-version.outputs.product-version }} \
            --build-number=${{ steps.get-build-number.outputs.build-number }} \
            --unlimited-organization=${{ github.repository_owner }} \
            --tag-suffix=${{ env.TAG_SUFFIX }} \
            --debian-package-suffix=${{ env.DEBIAN_PACKAGE_SUFFIX }} \
            --binaries-only
      
      - name: Docker build deb package
        run: |
          sudo ./onlyoffice-package-builder.sh \
            --product-version=${{ steps.get-product-version.outputs.product-version }} \
            --build-number=${{ steps.get-build-number.outputs.build-number }} \
            --unlimited-organization=${{ github.repository_owner }} \
            --tag-suffix=${{ env.TAG_SUFFIX }} \
            --debian-package-suffix=${{ env.DEBIAN_PACKAGE_SUFFIX }} \
            --deb-only
      
      - name: Find and release DEB package
        id: deb-release
        run: |
          # Find the DEB file
          RELEASE_DEB=$(find "${{ github.workspace }}" -name "onlyoffice-documentserver_${{ steps.get-product-version.outputs.product-version }}-${{ steps.get-build-number.outputs.build-number }}${{ env.DEBIAN_PACKAGE_SUFFIX }}_amd64.deb" -type f | head -1)
          
          if [ -z "$RELEASE_DEB" ]; then
            echo "❌ DEB package not found! Build failed."
            # List directories to debug
            find "${{ github.workspace }}" -type d -name "deb" | head -10
            find "${{ github.workspace }}" -name "*.deb" | head -10
            exit 1
          fi
          
          RELEASE_SHORT_DEB=$(basename "$RELEASE_DEB")
          echo "filename=${RELEASE_DEB}" >> $GITHUB_OUTPUT
          echo "shortfilename=${RELEASE_SHORT_DEB}" >> $GITHUB_OUTPUT
          echo "✅ Found DEB: ${RELEASE_SHORT_DEB}"
      
      - name: Release
        uses: crowbarmaster/GH-Automatic-Releases@v1.6.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          automatic_release_tag: onlyoffice-unlimited-build-${{ env.DISTRO_TAG_PREFIX }}/${{ steps.split-tag.outputs.version }}
          title: OnlyOffice ${{ steps.split-tag.outputs.version }} Unlimited Build ( ${{ env.DISTRO_FULLNAME }} )
          files: |
            ${{ steps.deb-release.outputs.filename }}
