name: release-onlyoffice

on:
  push:
    tags:
      - builds-debian-11/*

env:
  DEBIAN_PACKAGE_SUFFIX: -leadity
  TAG_SUFFIX: -leadity
  DISTRO_FULLNAME: Debian 11
  DISTRO_TAG_PREFIX: debian-11

jobs:
  onlyoffice-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Free Space
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo docker system prune -af
          df -h
      
      - name: Check out builder repo
        uses: actions/checkout@v4
        with:
          path: builder
      
      - name: Split branch name
        id: split-tag
        working-directory: builder
        run: echo "version=${GITHUB_REF_NAME##*/}" >> $GITHUB_OUTPUT
      
      - name: Get Product version
        id: get-product-version
        working-directory: builder
        run: echo "product-version=${VERSION%.*}" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.split-tag.outputs.version }}
      
      - name: Get Build number
        id: get-build-number
        working-directory: builder
        run: echo "build-number=${VERSION##$PRODUCT_VERSION.}" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.split-tag.outputs.version }}
          PRODUCT_VERSION: ${{ steps.get-product-version.outputs.product-version }}
      
      - name: Check out custom build_tools
        uses: actions/checkout@v4
        with:
          repository: leadity-GmbH/build_tools
          ref: v9.1.0.173-leadity-working
          path: build_tools
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check out server repo
        uses: actions/checkout@v4
        with:
          repository: leadity-GmbH/server
          ref: v9.1.0.173-leadity
          path: server
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check out web-apps repo
        uses: actions/checkout@v4
        with:
          repository: leadity-GmbH/web-apps
          ref: v9.1.0.173-leadity
          path: web-apps
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libssl-dev \
            libcurl4-openssl-dev \
            wget \
            unzip \
            pkg-config \
            qt5-qmake \
            qtbase5-dev \
            libqt5svg5-dev \
            libqt5websockets5-dev \
            qttools5-dev-tools \
            libboost-all-dev
      
      - name: Run build_tools directly
        working-directory: build_tools/tools/linux
        run: |
          # Make sure we have the right paths
          export PYTHONPATH=$PYTHONPATH:$(pwd)/../..
          
          # Try to build just the server
          python3 automate.py server --branch v9.1.0.173-leadity --repo-url-server https://github.com/leadity-GmbH/server.git --repo-url-web-apps https://github.com/leadity-GmbH/web-apps.git 2>&1 | tee build.log
          
          echo "=== BUILD EXIT CODE: $? ==="
      
      - name: Check build output
        if: always()
        working-directory: build_tools
        run: |
          echo "=== Build log ==="
          cat tools/linux/build.log || true
          
          echo "=== Checking for out directory ==="
          find . -name "out" -type d
          
          echo "=== Checking for documentserver ==="
          find . -path "*/onlyoffice/documentserver" -type d
          
          echo "=== Listing out/linux_64 ==="
          ls -la out/linux_64/ 2>/dev/null || echo "No out/linux_64"
          
          echo "=== Listing out/linux_64/onlyoffice ==="
          ls -la out/linux_64/onlyoffice/ 2>/dev/null || echo "No onlyoffice directory"
      
      - name: Build DEB package
        if: success()
        working-directory: builder/deb_build
        run: |
          # Copy the built files to where the DEB builder expects them
          mkdir -p document-server-package/common/documentserver/home
          cp -rf ../build_tools/out/linux_64/onlyoffice/documentserver/* document-server-package/common/documentserver/home/ || true
          
          # Run the DEB build script
          cd document-server-package
          ./make-deb.sh --version ${{ steps.get-product-version.outputs.product-version }} --release ${{ steps.get-build-number.outputs.build-number }}${{ env.DEBIAN_PACKAGE_SUFFIX }}
      
      - name: Find DEB package
        id: deb-release
        working-directory: builder
        run: |
          RELEASE_DEB=$(find "${{ github.workspace }}" -name "onlyoffice-documentserver_${{ steps.get-product-version.outputs.product-version }}-${{ steps.get-build-number.outputs.build-number }}${{ env.DEBIAN_PACKAGE_SUFFIX }}_amd64.deb" -type f | head -1)
          
          if [ -z "$RELEASE_DEB" ]; then
            echo "âŒ DEB package not found!"
            find "${{ github.workspace }}" -name "*.deb" -type f
            exit 1
          fi
          
          echo "filename=${RELEASE_DEB}" >> $GITHUB_OUTPUT
          echo "shortfilename=$(basename ${RELEASE_DEB})" >> $GITHUB_OUTPUT
      
      - name: Release
        uses: crowbarmaster/GH-Automatic-Releases@v1.6.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          automatic_release_tag: onlyoffice-unlimited-build-${{ env.DISTRO_TAG_PREFIX }}/${{ steps.split-tag.outputs.version }}
          title: OnlyOffice ${{ steps.split-tag.outputs.version }} Unlimited Build ( ${{ env.DISTRO_FULLNAME }} )
          files: |
            ${{ steps.deb-release.outputs.filename }}
